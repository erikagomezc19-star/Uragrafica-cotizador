<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Uragráfica — Cotizador</title>
<style>
  *{box-sizing:border-box;margin:0;padding:0;font-family:Arial,Helvetica,sans-serif}
  body{background:#f4f6f8;color:#111;line-height:1.45;font-size:15px}
  .wrap{max-width:1100px;margin:16px auto;padding:0 14px}
  .topbar{background:#1f73c3;color:#fff;padding:10px 14px;border-bottom:3px solid #135ca7}
  .topbar .bar{display:flex;justify-content:space-between;align-items:center}
  .logo{font-weight:800}
  h1{margin-top:6px;font-size:20px;font-weight:800;text-align:center}
  .actions{display:flex;gap:8px;align-items:center}
  button{cursor:pointer}
  .primary{background:#2ecc71;color:#fff;border:none;border-radius:8px;padding:8px 12px}
  .secondary{background:#0b57d0;color:#fff;border:none;border-radius:8px;padding:8px 12px}
  .ghost{background:#fff;border:1px solid #bcd0ea;color:#0b57d0;border-radius:8px;padding:8px 12px}

  .card{background:#fff;border:1px solid #e3e9ef;border-radius:12px;padding:14px;margin:12px 0;box-shadow:0 2px 10px rgba(0,0,0,.04)}
  .card h2{margin-bottom:8px;color:#0f2b46;font-size:18px}

  .grid{display:grid;gap:10px}
  .g4{grid-template-columns:repeat(4,1fr)}
  .g3{grid-template-columns:repeat(3,1fr)}

  label{display:flex;flex-direction:column;font-size:14px;color:#233}
  input,select,textarea{margin-top:6px;padding:10px;border:1px solid #c8d2dc;border-radius:8px;background:#f9fbfc}
  textarea{min-height:120px;resize:vertical}
  input:focus,select:focus,textarea:focus{outline:none;border-color:#1f73c3;background:#fff}

  .muted{font-size:12px;color:#6a7d90;margin-top:6px}
  .detalle{min-height:64px;border:1px dashed #c9d3dd;border-radius:10px;padding:10px;background:#fbfdff}
  .money{font-weight:800}
  .money.total{color:#e53935;font-size:18px}
  .row{display:flex;justify-content:space-between;margin:4px 0}

  .tabla-cat{margin-top:8px;border:1px solid #e4e9ef;border-radius:10px;overflow:hidden}
  .tabla-cat table{width:100%;border-collapse:collapse}
  .tabla-cat th,.tabla-cat td{padding:8px;border-top:1px solid #eef2f6;font-size:13px}
  .tabla-cat thead th{background:#f7fafc;text-align:left;color:#274664}
  .chip{background:#eef6ff;border:1px solid #cfe2ff;padding:0 8px;border-radius:12px;font-size:12px}

  .del{background:#ffebee;border:1px solid #ffcdd2;color:#c62828;padding:6px 10px;border-radius:8px;cursor:pointer}
  .edit{background:#e8f5e9;border:1px solid #c8e6c9;color:#1b5e20;padding:6px 10px;border-radius:8px;cursor:pointer;margin-right:6px}

  .mt8{margin-top:8px}
  .print{display:none}
  @media print{.topbar,.card:not(.print){display:none!important}.print{display:block;border:none;box-shadow:none}}
</style>
</head>
<body>
<header class="topbar">
  <div class="bar">
    <div class="logo">Uragráfica</div>
    <div class="actions">
      <span id="syncBadge" class="chip">Cargando…</span>
      <button id="btnCalcular" class="primary">Calcular</button>
      <button id="btnPrint" class="secondary">Imprimir / PDF</button>
    </div>
  </div>
  <h1>Cotizador</h1>
</header>

<main class="wrap">
  <!-- Cotizador -->
  <section class="card">
    <h2>Selecciona</h2>
    <div class="grid g4">
      <label>Categoría *
        <select id="categoria"><option>Cargando…</option></select>
      </label>
      <label>Producto *
        <select id="producto"><option>—</option></select>
      </label>
      <label>Cantidad *
        <input id="cantidad" type="number" min="1" value="1000"/>
      </label>
      <label>IVA
        <div style="display:flex;gap:8px;align-items:center;margin-top:6px">
          <input id="incluirIVA" type="checkbox"/>
          <span>Incluir IVA (19%)</span>
        </div>
      </label>
    </div>
    <div id="ayuda" class="muted">—</div>
  </section>

  <!-- Resultado -->
  <section class="card">
    <h2>Detalle</h2>
    <div id="detalle" class="detalle">Presiona “Calcular”.</div>
    <div class="grid g3 mt8">
      <div>
        <div class="muted">Subtotal + IVA</div>
        <div id="subProd" class="money">—</div>
      </div>
      <div></div>
      <div>
        <div class="muted">TOTAL</div>
        <div id="total" class="money total">—</div>
      </div>
    </div>
  </section>

  <!-- Gestión -->
  <section class="card">
    <h2>Catálogo (agregar / editar / eliminar)</h2>

    <div class="grid g4">
      <label>Categoría
        <input id="g_cat" placeholder="p.ej. Talonarios"/>
      </label>
      <label>Producto
        <input id="g_name" placeholder="Nombre del producto"/>
      </label>
      <label>Tipo de precio
        <select id="g_tipo">
          <option value="tier" selected>Por cantidad (tiers)</option>
          <option value="unit">Unitario</option>
        </select>
      </label>
      <label id="g_qty_wrap">Cantidad (para tier)
        <input id="g_qty" type="number" min="1" value="1000"/>
      </label>
    </div>

    <div class="grid g3 mt8">
      <label>Precio (COP)
        <input id="g_price" type="number" min="0" value="0"/>
      </label>
      <div style="display:flex;gap:8px;align-items:end">
        <button id="btnAgregar" class="primary">Agregar / Actualizar</button>
        <button id="btnLimpiar" class="ghost">Limpiar formulario</button>
      </div>
    </div>

    <div class="mt8">
      <details>
        <summary><b>Importación masiva</b> (pega: <i>Nombre [tab] Cantidad [tab] Precio</i>)</summary>
        <div class="mt8 grid g4">
          <label>Destino (si no auto)
            <input id="bulk_cat" placeholder="p.ej. Talonarios" value="Talonarios"/>
          </label>
          <label style="grid-column:span 2;display:flex;align-items:end;gap:8px">
            <input id="bulk_autocat" type="checkbox" checked/>
            <span>Auto separar por categoría (según nombre)</span>
          </label>
        </div>
        <textarea id="bulk_text" placeholder="Ej:
STICKER LAMINADO TROQUELADO 5X5	1000	178000
ADHESIVO 80X40 SIN LAMINAR	1	25000
..."></textarea>
        <div class="mt8" style="display:flex;gap:8px">
          <button id="btnBulk" class="ghost">Cargar líneas</button>
          <span class="muted">Líneas iguales se agrupan como tiers.</span>
        </div>
      </details>
    </div>

    <div class="mt8">
      <div class="muted">Ítems de la categoría seleccionada:</div>
      <div id="tablaCat" class="tabla-cat"></div>
    </div>
  </section>

  <!-- Vista impresión -->
  <section class="card print">
    <h2>COTIZACIÓN</h2>
    <div id="pv"></div>
  </section>
</main>

<!-- Firebase + App -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
  getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot,
  serverTimestamp, query, orderBy
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

/* ⚠️ TU CONFIG AQUÍ */
const firebaseConfig = {
  apiKey: "TU_API_KEY",
  authDomain: "TU_AUTH_DOMAIN",
  projectId: "TU_PROJECT_ID",
  storageBucket: "TU_BUCKET",
  messagingSenderId: "TU_SENDER_ID",
  appId: "TU_APP_ID"
};

const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);
const col = collection(db, "catalog");

const $=s=>document.querySelector(s);
const fmt=new Intl.NumberFormat("es-CO",{style:"currency",currency:"COP",maximumFractionDigits:0});
const money=v=>fmt.format(Math.round(v||0));
const int=n=>Math.max(0,parseInt(n||0,10));
const clean=s=>(s||"").toString().trim();
const BADGE=$("#syncBadge");
function setBadge(t){ BADGE.textContent=t; }

/* ======= Estado ======= */
let CAT={};      // {categoria: [items]}
let INDEX={};    // {categoria: {name: item}}
const CACHE="uragrafica_cache_v4";

/* ======= Helpers ======= */
const docId = (cat,name)=>encodeURIComponent(`${cat}:::${name}`);
function autoCategory(name){
  const s=(name||"").toUpperCase();
  if (/(^|\s)STI?C?K?KER(S)?\b|(^|\s)STIKER(S)?\b|PEGATINA(S)?\b|CALCOMANI(A|AS)\b/.test(s)) return "Stickers";
  if (/\bADHESIV(O|A|OS|AS)\b|VINIL(O|OS)\b|MICROPERFORAD/.test(s)) return "Adhesivos";
  if(/VASO|MUG|TAZA/.test(s)) return "Vasos/Mugs";
  if(/TARJETA/.test(s)) return "Tarjetas";
  if(/VOLANTE/.test(s)) return "Volantes";
  if(/\bGOMA\s*SELLO\b/.test(s)) return "Gomas de sello";
  if(/CAJA.*SELLO|TRODAT.*CAJA|CAJA\s+DE\s+SELLO/.test(s)) return "Cajas para sello";
  if(/SELLO|FECHADOR|FECHERO/.test(s)) return "Sellos";
  if(/TALONARIO|LORD/.test(s)) return "Talonarios";
  if(/PEND(Ó|O)N|ROLL\s*UP|ARAÑA|LONA|BANNER|VALLA|BACKING/.test(s)) return "Grandes Formatos";
  if(/AGENDA/.test(s)) return "Agendas";
  if(/CARNET|TESLI/.test(s)) return "Carnets";
  if(/AFICHE/.test(s)) return "Afiches";
  if(/BOLETA/.test(s)) return "Boletas";
  if(/CARTA MEN(Ú|U)/.test(s)) return "Cartas Menú";
  if(/LLAVEROS|LAPICERO|BOTONES|MANILLAS|ABANICO|PASTELITOS|PORTAFOLIOS/.test(s)) return "Promocionales";
  if(/LAMINA|OPAL|TABLAS\s+DE\s+PRECIO/.test(s)) return "Materiales";
  if(/CORTE DE PAPEL|TIJERA|ROMPE\s*TRAFICO/.test(s)) return "Servicios";
  if(/IMPRESIÓN|IMPRESION/.test(s)) return "Impresión";
  return "Otros";
}

/* ======= UI ======= */
function rebuildIndex(){
  INDEX={};
  Object.keys(CAT).forEach(k=>{
    INDEX[k]={};
    (CAT[k]||[]).forEach(it=>INDEX[k][it.name]=it);
  });
}
function fillCats(){
  const sel=$("#categoria"); const keep=sel.value; sel.innerHTML="";
  Object.keys(CAT).sort().forEach(c=>{
    const o=document.createElement("option"); o.value=o.textContent=c; sel.appendChild(o);
  });
  if(keep && CAT[keep]) sel.value=keep; else sel.selectedIndex=0;
}
function fillProducts(){
  const cat=$("#categoria").value; const sel=$("#producto"); const keep=sel.value; sel.innerHTML="";
  (CAT[cat]||[]).map(x=>x.name).sort().forEach(n=>{
    const o=document.createElement("option"); o.value=o.textContent=n; sel.appendChild(o);
  });
  if((CAT[cat]||[]).some(x=>x.name===keep)) sel.value=keep; else sel.selectedIndex=0;
}
function setHint(){
  const cat=$("#categoria").value, name=$("#producto").value;
  const it=(INDEX[cat]||{})[name]; const el=$("#ayuda");
  if(!it){ el.textContent="—"; return; }
  if(it.unit) el.textContent=`Unitario: ${money(it.unit)} × cantidad.`;
  else if(it.tiers?.length){
    const txt=it.tiers.map(t=>`${t.qty} → ${money(t.price)}`).slice(0,8).join(" · ");
    el.textContent=`Tirajes: ${txt}${it.tiers.length>8?" …":""}`;
  } else el.textContent="Ítem sin precio.";
}
function renderTable(){
  const cat=$("#categoria").value; const cont=$("#tablaCat"); const arr=CAT[cat]||[];
  if(!arr.length){ cont.innerHTML="<div class='muted' style='padding:8px'>No hay ítems.</div>"; return; }
  const rows=arr.map((it)=>{
    const tipo=it.unit?`<span class="chip">Unitario</span>`:`<span class="chip">Por cantidad</span>`;
    const val = it.unit? money(it.unit) : it.tiers.map(t=>`${t.qty}→${money(t.price)}`).join(" · ");
    return `<tr>
      <td>${it.name}</td>
      <td>${tipo}</td>
      <td>${val||"-"}</td>
      <td style="text-align:right">
        <button class="edit" data-name="${encodeURIComponent(it.name)}">Editar</button>
        <button class="del" data-name="${encodeURIComponent(it.name)}">Eliminar</button>
      </td>
    </tr>`;
  }).join("");
  cont.innerHTML=`<table>
    <thead><tr><th>Producto</th><th>Tipo</th><th>Precio / Tiers</th><th></th></tr></thead>
    <tbody>${rows}</tbody></table>`;

  cont.querySelectorAll(".del").forEach(b=>{
    b.addEventListener("click",async ()=>{
      const cat=$("#categoria").value;
      const name=decodeURIComponent(b.dataset.name);
      if(!confirm(`¿Eliminar “${name}”?`)) return;
      await deleteDoc(doc(db,"catalog",docId(cat,name)));
      setBadge("Eliminado ✓");
    });
  });
  cont.querySelectorAll(".edit").forEach(b=>{
    b.addEventListener("click",()=>{
      const cat=$("#categoria").value;
      const name=decodeURIComponent(b.dataset.name);
      const it=(CAT[cat]||[]).find(x=>x.name===name);
      $("#g_cat").value=cat;
      $("#g_name").value=it.name;
      if(it.unit){
        $("#g_tipo").value="unit";
        $("#g_qty").disabled=true; $("#g_qty_wrap").style.opacity=0.35;
        $("#g_price").value=it.unit;
      }else{
        $("#g_tipo").value="tier";
        $("#g_qty").disabled=false; $("#g_qty_wrap").style.opacity=1;
        const first=it.tiers[0]||{qty:1000,price:0};
        $("#g_qty").value=first.qty;
        $("#g_price").value=first.price;
        alert("Edita precio/cantidad y pulsa “Agregar / Actualizar”. Cambia cantidad para añadir otro tier.");
      }
      window.scrollTo({top:0,behavior:"smooth"});
    });
  });
}
function applyAndRender(){
  localStorage.setItem(CACHE, JSON.stringify(CAT));
  rebuildIndex(); fillCats(); fillProducts(); setHint(); renderTable();
  setBadge("Listo ✓");
}

/* ======= Cálculo ======= */
function priceByQty(it,qty){
  if(!it) return {base:0};
  if(it.unit && !(it.tiers?.length)) return {base:it.unit*qty};
  if(it.tiers?.length){
    const tiers=[...it.tiers].sort((a,b)=>a.qty-b.qty);
    const exact=tiers.find(t=>t.qty===qty);
    if(exact) return {base:exact.price};
    let lower=null, higher=null;
    for(const t of tiers){ if(t.qty<=qty) lower=t; if(t.qty>=qty){ higher=t; break; } }
    const chosen = lower || higher || tiers[0];
    const unit   = chosen.price / chosen.qty;
    return {base:unit*qty};
  }
  return {base:0};
}
function calcular(){
  const cat=$("#categoria").value, name=$("#producto").value, qty=int($("#cantidad").value);
  const incIVA=$("#incluirIVA").checked;
  const it=(INDEX[cat]||{})[name];
  const {base}=priceByQty(it,qty);
  const subtotal=base, iva=incIVA?subtotal*0.19:0, total=subtotal+iva;

  $("#detalle").innerHTML = `
    <div class="row"><div>${name}</div><div class="money">${money(base)}</div></div>
    <hr style="border:none;border-top:1px dashed #c9d3dd;margin:6px 0;">
    <div class="row"><span>IVA ${incIVA?"(19%)":"(no incluido)"}</span><strong>${money(iva)}</strong></div>`;
  $("#subProd").textContent=money(subtotal+iva);
  $("#total").textContent=money(total);

  $("#pv").innerHTML=`
    <div class="row"><strong>Producto:</strong><span>${name}</span></div>
    <div class="row"><strong>Categoría:</strong><span>${cat}</span></div>
    <div class="row"><strong>Cantidad:</strong><span>${qty.toLocaleString("es-CO")}</span></div>
    <div class="row"><strong>Subtotal:</strong><span>${money(subtotal)}</span></div>
    <div class="row"><strong>IVA:</strong><span>${money(iva)}</span></div>
    <div class="row"><strong>TOTAL:</strong><span>${money(total)}</span></div>`;
}

/* ======= CRUD remoto ======= */
async function upsertItem(item){
  await setDoc(doc(db,"catalog",docId(item.category,item.name)), {
    ...item,
    updatedAt: serverTimestamp()
  });
}
function ensureCat(c){ if(!CAT[c]) CAT[c]=[]; }
function upsertLocal(item){
  ensureCat(item.category);
  const arr=CAT[item.category];
  const i = arr.findIndex(x=>x.name===item.name);
  if(i>=0) arr[i]=item; else arr.push(item);
}
async function agregar(){
  const cat = clean($("#g_cat").value) || $("#categoria").value || "Catálogo";
  const name= clean($("#g_name").value);
  const tipo=$("#g_tipo").value;
  const qty = int($("#g_qty").value);
  const price = int($("#g_price").value);
  if(!cat || !name || (tipo==="tier" && (!qty||!price)) || (tipo==="unit" && !price)){
    alert("Completa categoría, producto y precio (y cantidad si es por tier)."); return;
  }
  const item = {category:cat, name, unit:null, tiers:[]};
  if(tipo==="unit"){ item.unit=price; }
  else { item.tiers=[{qty,price}]; }

  // Merge tiers si ya existe localmente
  const prev = (CAT[cat]||[]).find(x=>x.name===name);
  if(prev){
    if(tipo==="unit"){ item.tiers = []; }
    else{
      const map = new Map();
      (prev.tiers||[]).forEach(t=>map.set(t.qty,t.price));
      map.set(qty,price);
      item.tiers = [...map.entries()].map(([q,p])=>({qty:q,price:p})).sort((a,b)=>a.qty-b.qty);
    }
  }

  await upsertItem(item); // remoto; onSnapshot actualizará a todos
  setBadge("Guardado ✓");
  $("#g_name").value=""; $("#g_price").value="0"; $("#g_qty").value="1000";
}

/* ======= Carga inicial (cache + tiempo real) ======= */
function loadCache(){
  try{
    const raw=localStorage.getItem(CACHE);
    if(raw){ CAT=JSON.parse(raw)||{}; applyAndRender(); setBadge("Cache ✓"); }
  }catch{}
}
function subscribe(){
  const q = query(col, orderBy("category"), orderBy("name"));
  onSnapshot(q, (snap)=>{
    const next={};
    snap.forEach(d=>{
      const it=d.data();
      ensureCat(it.category);
      const item={
        category: it.category,
        name: it.name,
        unit: it.unit ?? null,
        tiers: Array.isArray(it.tiers)? it.tiers.map(t=>({qty:t.qty,price:t.price})).sort((a,b)=>a.qty-b.qty) : []
      };
      ensureCat(item.category);
      if(!next[item.category]) next[item.category]=[];
      next[item.category].push(item);
    });
    CAT=next; applyAndRender(); setBadge("En vivo ✓");
  }, (err)=>{
    console.warn(err); setBadge("Offline (cache)");
  });
}

/* ======= Importación masiva ======= */
function parseMoney(s){
  s=(s||"").toString().trim();
  s=s.replace(/[^\d,\.]/g,"");
  if(/^\d+,\d+$/.test(s)) s=s.replace(",", "");
  s=s.replace(/\./g,"").replace(/,/g,"");
  const v=parseInt(s||"0",10);
  return isFinite(v)?v:0;
}
async function bulkImport(txt,{auto=true,dest="Catálogo"}={}){
  const lines=(txt||"").split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
  for(const ln of lines){
    const p=ln.split(/\t+/);
    if(p.length<3) continue;
    const name=clean(p[0]); const qty=int(p[1]); const price=parseMoney(p[2]);
    if(!name||!qty||price<0) continue;
    const cat = auto ? autoCategory(name) : dest;
    const existing = (CAT[cat]||[]).find(x=>x.name===name);
    let item = existing ? structuredClone(existing) : {category:cat,name,unit:null,tiers:[]};
    const i = (item.tiers||[]).findIndex(t=>t.qty===qty);
    if(i>=0) item.tiers[i].price=price; else item.tiers.push({qty,price});
    item.tiers.sort((a,b)=>a.qty-b.qty);
    await upsertItem(item);
  }
  setBadge("Importado ✓");
}
$("#btnBulk").addEventListener("click",()=>{
  const txt=$("#bulk_text").value;
  const auto=$("#bulk_autocat").checked;
  const dest=clean($("#bulk_cat").value)||"Catálogo";
  bulkImport(txt,{auto,dest});
});

/* ======= Eventos ======= */
$("#btnCalcular").addEventListener("click",calcular);
$("#btnPrint").addEventListener("click",()=>window.print());
$("#categoria").addEventListener("change",()=>{fillProducts();setHint();renderTable();});
$("#producto").addEventListener("change",setHint);
$("#btnAgregar").addEventListener("click",agregar);
$("#btnLimpiar").addEventListener("click",()=>{
  $("#g_cat").value=""; $("#g_name").value="";
  $("#g_tipo").value="tier";
  $("#g_qty").disabled=false; $("#g_qty_wrap").style.opacity=1; $("#g_qty").value="1000";
  $("#g_price").value="0";
});
$("#g_tipo").addEventListener("change",()=>{
  const isU=$("#g_tipo").value==="unit";
  $("#g_qty").disabled=isU;
  $("#g_qty_wrap").style.opacity = isU ? 0.35 : 1;
});

/* ======= Arranque ======= */
loadCache();   // aparece al instante
subscribe();   // actualiza en vivo
</script>
</body>
</html>


